<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>角色管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">

        <blockquote class="layui-elem-quote layui-text" style="padding: 10px;">
            <i class="layui-icon layui-icon-list"></i> 角色列表
            <button class="layui-btn layui-btn-sm layui-btn-normal layuimini-btn-primary" style="float: right;" id="createRoleBtn">
                <i class="layui-icon layui-icon-add-1"></i> 新建角色
            </button>
        </blockquote>

        <div class="layui-row layui-col-space15" id="roleCardContainer">
            </div>

    </div>
</div>
<script src="../../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script>
    layui.use(['jquery', 'layer'], function () {
        var $ = layui.jquery,
            layer = layui.layer;

        // 模拟权限数据
        var permissions = [
            { title: '零件信息管理', id: 10, children: [
                { title: '查看零件信息', id: 101 },
                { title: '新增零件信息', id: 102 },
                { title: '编辑零件信息', id: 103 },
                { title: '删除零件信息', id: 104 }
            ]},
            { title: '销售订单管理', id: 20, children: [
                { title: '查看销售订单', id: 201 },
                { title: '创建销售订单', id: 202 },
                { title: '修改销售订单', id: 203 },
                { title: '取消销售订单', id: 204 }
            ]},
            { title: '采购订单管理', id: 30, children: [
                { title: '查看采购订单', id: 301 },
                { title: '创建采购订单', id: 302 },
                { title: '修改采购订单', id: 303 },
                { title: '取消采购订单', id: 304 }
            ]},
            { title: '仓库库存管理', id: 40, children: [
                { title: '查看库存', id: 401 },
                { title: '入库操作', id: 402 },
                { title: '出库操作', id: 403 },
                { title: '盘点操作', id: 404 }
            ]},
            { title: '应收账款管理', id: 50, children: [
                { title: '查看应收款', id: 501 },
                { title: '进行收款操作', id: 502 }
            ]},
            { title: '系统管理', id: 60, children: [
                { title: '用户管理', id: 601 },
                { title: '角色管理', id: 602 },
                { title: '日志查看', id: 603 }
            ]}
        ];
        
        // 渲染角色卡片
        function renderRoleCards(roles) {
            var container = $('#roleCardContainer');
            container.empty();
            $.each(roles, function(index, role){
                var cardHtml = '<div class="layui-col-md3">' +
                    '<div class="layui-card">' +
                        '<div class="layui-card-header">' + role.role_name + '</div>' +
                        '<div class="layui-card-body">' +
                            '<p>权限数量: ' + role.permissions.length + ' 个</p>' +
                            '<p style="margin-top: 10px;">' +
                                '<button class="layui-btn layui-btn-sm edit-btn" data-id="' + role.role_id + '" data-name="' + role.role_name + '">编辑权限</button>' +
                            '</p>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                container.append(cardHtml);
            });
        }

        // 获取并渲染初始角色
        $.getJSON('../../api/role.json', function(res){
            renderRoleCards(res.data);
        });

        // 绑定编辑权限按钮事件
        $(document).on('click', '.edit-btn', function(){
            var roleId = $(this).data('id');
            var roleName = $(this).data('name');
            var roleData = {};
            
            // 模拟获取当前角色的权限
            $.getJSON('../../api/role.json', function(res){
                roleData = res.data.find(function(item){
                    return item.role_id === roleId;
                });
                showPermissionModal(roleData.permissions, roleName, roleId);
            });
        });

        // 绑定新建角色按钮事件
        $('#createRoleBtn').on('click', function(){
            showPermissionModal([], '新建角色');
        });

        // 显示权限选择弹窗
        function showPermissionModal(currentPermissions, roleName, roleId) {
            var permissionHtml = '<div style="padding: 20px;">' +
                '<form class="layui-form layui-form-pane" lay-filter="permissionForm">' +
                    '<div class="layui-form-item">' +
                        '<label class="layui-form-label">角色名称</label>' +
                        '<div class="layui-input-block">' +
                            '<input type="text" name="role_name" lay-verify="required" value="' + (roleName === '新建角色' ? '' : roleName) + '" autocomplete="off" class="layui-input">' +
                        '</div>' +
                    '</div>' +
                    '<div class="layui-form-item layui-form-text">' +
                        '<label class="layui-form-label">权限配置</label>' +
                        '<div class="layui-input-block">';

            $.each(permissions, function(index, module){
                permissionHtml += '<p style="font-weight: bold; margin-top: 10px;">' + module.title + '</p>';
                $.each(module.children, function(i, perm){
                    var checked = currentPermissions.includes(perm.id) ? 'checked' : '';
                    permissionHtml += '<input type="checkbox" name="permission" title="' + perm.title + '" value="' + perm.id + '" ' + checked + '>';
                });
            });

            permissionHtml += '</div></div>' +
                    '<div class="layui-form-item">' +
                        '<div class="layui-input-block">' +
                            '<button class="layui-btn" lay-submit lay-filter="permissionSubmit">保存</button>' +
                        '</div>' +
                    '</div>' +
                '</form>' +
            '</div>';

            layer.open({
                type: 1,
                title: roleName,
                area: ['500px', '550px'],
                content: permissionHtml,
                success: function(){
                    layui.form.render();
                    
                    layui.form.on('submit(permissionSubmit)', function(data){
                        var newRoleName = data.field.role_name;
                        var selectedPermissions = [];
                        $('input[name="permission"]:checked').each(function(){
                            selectedPermissions.push(parseInt($(this).val()));
                        });
                        
                        if(roleId){
                             layer.msg('角色 "' + newRoleName + '" 的权限已更新，该角色下所有用户的权限将同步更新。', {icon: 1});
                        } else {
                            layer.msg('新角色 "' + newRoleName + '" 创建成功！', {icon: 1});
                        }
                        
                        // 模拟更新数据
                        $.getJSON('../../api/role.json', function(res){
                            if(roleId){
                                var targetRole = res.data.find(function(item){ return item.role_id === roleId; });
                                if(targetRole){
                                    targetRole.role_name = newRoleName;
                                    targetRole.permissions = selectedPermissions;
                                }
                            } else {
                                var newRole = {
                                    role_id: new Date().getTime(),
                                    role_name: newRoleName,
                                    permissions: selectedPermissions
                                };
                                res.data.push(newRole);
                            }
                            renderRoleCards(res.data);
                            layer.closeAll();
                        });

                        return false;
                    });
                }
            });
        }
    });
</script>
</body>
</html>