<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>用户管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>新建用户</legend>
        </fieldset>
        <form class="layui-form" lay-filter="userForm" style="width: 90%;padding-left: 20px;">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label required">用户名</label>
                    <div class="layui-input-block">
                        <input type="text" name="username" lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label required">部门</label>
                    <div class="layui-input-block">
                        <select name="department" lay-verify="required">
                            <option value="">请选择部门</option>
                            <option value="采购部">采购部</option>
                            <option value="销售部">销售部</option>
                            <option value="财务部">财务部</option>
                            <option value="仓储部">仓储部</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label required">初始密码</label>
                    <div class="layui-input-block">
                        <input type="text" name="password" value="123456" lay-verify="required" autocomplete="off" class="layui-input" readonly>
                    </div>
                </div>
            </div>
             <blockquote class="layui-elem-quote layui-quote-nm">提示：新用户首次登录后需强制修改密码。</blockquote>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="userSubmit">保存用户</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>

        <hr/>
        
        <fieldset class="table-search-fieldset">
            <legend>用户列表</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">用户名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="username_filter" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary" lay-submit lay-filter="data-search-btn"><i class="layui-icon"></i> 搜 索</button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <table class="layui-hide" id="userTable" lay-filter="userTableFilter"></table>

        <hr/>

        <fieldset class="table-search-fieldset">
            <legend>登录日志</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">用户</label>
                            <div class="layui-input-inline">
                                <input type="text" name="log_username_filter" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">日期范围</label>
                            <div class="layui-input-inline">
                                <input type="text" name="log_date_range" id="logDateRange" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary" lay-submit lay-filter="log-search-btn"><i class="layui-icon"></i> 搜 索</button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>
        
        <table class="layui-hide" id="logTable" lay-filter="logTableFilter"></table>

    </div>
</div>
<script src="../../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'table', 'layer', 'laydate'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            layer = layui.layer,
            laydate = layui.laydate;

        // 初始化日期范围选择器
        laydate.render({
            elem: '#logDateRange',
            range: true
        });

        // 渲染用户表格
        var userTableInstance = table.render({
            elem: '#userTable',
            url: '../../api/user.json',
            defaultToolbar: ['filter', 'exports', 'print'],
            cols: [[
                {field: 'id', width: 80, title: 'ID', sort: true},
                {field: 'username', width: 120, title: '用户名'},
                {field: 'department', width: 120, title: '部门'},
                {field: 'status', width: 100, title: '状态', templet: function(d){
                     var checked = d.status === '启用' ? 'checked' : '';
                     return '<input type="checkbox" name="status" lay-skin="switch" lay-text="启用|禁用" lay-filter="statusSwitch" ' + checked + ' data-id="' + d.id + '">';
                }},
                {field: 'last_login_time', width: 180, title: '最后登录时间'},
                {field: 'create_time', width: 180, title: '创建时间'}
            ]],
            limits: [10, 15, 20, 25, 50, 100],
            limit: 15,
            page: true,
            skin: 'line'
        });

        // 监听用户状态开关
        form.on('switch(statusSwitch)', function(obj){
            var id = $(obj.elem).data('id');
            var status = obj.elem.checked ? '启用' : '禁用';
            layer.tips('用户 ' + id + ' 状态已切换为：' + status, obj.othis);
        });

        // 监听用户搜索操作
        form.on('submit(data-search-btn)', function (data) {
            var keyword = data.field.username_filter;
            $.getJSON('../../api/user.json', function(res){
                var filteredData = res.data.filter(function(item){
                    return item.username.includes(keyword);
                });
                userTableInstance.reload({ data: filteredData });
            });
            return false;
        });

        // 监听用户创建表单
        form.on('submit(userSubmit)', function(data){
            layer.msg('新用户 ' + data.field.username + ' 创建成功！', {icon: 1});
            // 模拟将新用户添加到列表中
            var newUserData = {
                id: new Date().getTime(),
                username: data.field.username,
                department: data.field.department,
                status: '启用',
                last_login_time: '暂无',
                create_time: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString()
            };
            var oldData = table.cache.userTable;
            oldData.push(newUserData);
            userTableInstance.reload({ data: oldData });
            // 重置表单
            form.val("userForm", {
                "username": "",
                "department": ""
            });
            return false;
        });

        // 渲染登录日志表格
        var logTableInstance = table.render({
            elem: '#logTable',
            url: '../../api/loginLog.json',
            defaultToolbar: ['filter', 'exports', 'print'],
            cols: [[
                {field: 'log_id', width: 150, title: '日志ID'},
                {field: 'username', width: 120, title: '用户'},
                {field: 'login_time', width: 180, title: '登录时间', sort: true},
                {field: 'login_ip', width: 120, title: '登录IP'},
                {field: 'status', width: 100, title: '登录状态', templet: function(d){
                     var color = d.status === '成功' ? 'green' : 'red';
                     return '<span style="color:' + color + ';">' + d.status + '</span>';
                }}
            ]],
            limits: [10, 15, 20, 25, 50, 100],
            limit: 15,
            page: true,
            skin: 'line'
        });
        
        // 监听登录日志搜索
        form.on('submit(log-search-btn)', function (data) {
            var keyword = data.field.log_username_filter;
            var dateRange = data.field.log_date_range.split(' - ');
            var startDate = dateRange[0] ? new Date(dateRange[0]) : null;
            var endDate = dateRange[1] ? new Date(dateRange[1]) : null;
            
            $.getJSON('../../api/loginLog.json', function(res){
                var filteredData = res.data.filter(function(item){
                    var itemDate = new Date(item.login_time.split(' ')[0]);
                    var dateMatch = (!startDate || itemDate >= startDate) && (!endDate || itemDate <= endDate);
                    var userMatch = item.username.includes(keyword);
                    return dateMatch && userMatch;
                });
                logTableInstance.reload({ data: filteredData });
            });
            return false;
        });
    });
</script>
</body>
</html>