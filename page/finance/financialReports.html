<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>财务报表生成</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">

        <div class="layui-form-item">
            <button class="layui-btn layui-btn-primary" id="generateReportBtn">
                <i class="layui-icon layui-icon-add-1"></i> 生成报表
            </button>
        </div>

        <table class="layui-hide" id="reportTable" lay-filter="reportTableFilter"></table>

        <script type="text/html" id="report-tool">
            <a class="layui-btn layui-btn-xs" lay-event="view">查看</a>
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="download">下载</a>
        </script>

    </div>
</div>
<script src="../../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'table', 'jquery', 'layer', 'laydate'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            layer = layui.layer,
            laydate = layui.laydate;

        // 模拟数据缓存，用于动态添加新报表
        var reportDataCache = [];

        // 渲染表格
        var reportTableInstance = table.render({
            elem: '#reportTable',
            url: '../../api/financialReports.json',
            toolbar: '#toolbarDemo',
            defaultToolbar: ['filter', 'exports', 'print', {
                title: '提示',
                layEvent: 'LAYTABLE_TIPS',
                icon: 'layui-icon-tips'
            }],
            cols: [[
                {field: 'id', width: 80, title: 'ID', sort: true},
                {field: 'report_name', title: '报表名称'},
                {field: 'report_date', width: 150, title: '生成日期'},
                {field: 'status', width: 100, title: '状态', templet: '#statusTpl'},
                {title: '操作', minWidth: 150, templet: '#report-tool', fixed: "right", align: "center"}
            ]],
            page: true,
            skin: 'line',
            done: function(res, curr, count){
                // 首次加载时缓存数据
                if(reportDataCache.length === 0) {
                    reportDataCache = res.data;
                }
            }
        });

        // 监听表格操作列
        table.on('tool(reportTableFilter)', function(obj){
            var data = obj.data;
            if(obj.event === 'view'){
                layer.msg('查看报表: ' + data.report_name, {icon: 6});
            } else if(obj.event === 'download'){
                if(data.download_url){
                     layer.msg('已触发下载: ' + data.report_name, {icon: 6});
                } else {
                     layer.msg('该报表暂无下载链接！', {icon: 5});
                }
            }
        });
        
        // 监听“生成报表”按钮
        $('#generateReportBtn').on('click', function(){
            layer.open({
                type: 1,
                title: '生成新的财务报表',
                area: ['500px', '300px'],
                content: '<div style="padding: 20px;">' +
                            '<form class="layui-form" lay-filter="generateForm">' +
                                '<div class="layui-form-item">' +
                                    '<label class="layui-form-label">报表名称</label>' +
                                    '<div class="layui-input-block">' +
                                        '<input type="text" name="report_name" lay-verify="required" autocomplete="off" class="layui-input">' +
                                    '</div>' +
                                '</div>' +
                                '<div class="layui-form-item">' +
                                    '<label class="layui-form-label">时间范围</label>' +
                                    '<div class="layui-input-block">' +
                                        '<input type="text" id="reportDate" name="report_date" lay-verify="required" autocomplete="off" class="layui-input" readonly>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="layui-form-item">' +
                                    '<div class="layui-input-block">' +
                                        '<button class="layui-btn" lay-submit lay-filter="submitGenerate">生成</button>' +
                                    '</div>' +
                                '</div>' +
                            '</form>' +
                         '</div>',
                success: function(layero, index){
                     // 渲染日期选择器，并设置为范围选择
                    laydate.render({
                        elem: '#reportDate',
                        range: true // 关键修改点
                    });
                    // 监听弹窗内的表单提交
                    form.on('submit(submitGenerate)', function(data){
                         // 模拟生成新报表数据
                         var newReport = {
                            id: new Date().getTime(), // 动态生成一个ID
                            report_name: data.field.report_name,
                            report_date: data.field.report_date,
                            report_type: '自定义报表',
                            creator: '系统自动生成',
                            status: '已归档',
                            download_url: ''
                         };
                         // 将新报表添加到数据缓存
                         reportDataCache.unshift(newReport);
                         // 重新加载表格数据
                         table.reload('reportTable', { data: reportDataCache });
                         layer.close(index); // 关闭弹窗
                         layer.msg('报表已成功生成！', {icon: 1});
                         return false;
                    });
                }
            });
        });

    });
</script>
<script type="text/html" id="statusTpl">
    {{#  if(d.status === '已归档'){ }}
    <span class="layui-badge layui-bg-green">{{d.status}}</span>
    {{#  } else { }}
    <span class="layui-badge layui-bg-orange">{{d.status}}</span>
    {{#  } }}
</script>
</body>
</html>